\chapter{Syntax and Parsing}

\section{Lexical Structure}

Overview:

\begin{align*}
    \begin{array}{rcll}
        \mathit{program}^\mathrm{lex}
        &\Coloneq &(\mathit{whitespace}^\mathrm{lex} \mathrel{/} \mathit{lexeme}^\mathrm{lex}){*}\; \mathbf{EOS} \\
        \mathit{lexeme}^\mathrm{lex}
        &\Coloneq &\mathit{literal\_part}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{literal}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{delimit\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{keyword\_id}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{keyword\_sym}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{free\_id}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{var\_id}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{var\_sym}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{con\_id}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{con\_sym}^\mathrm{lex}
    \end{array}
\end{align*}

Identifier:

\begin{align*}
    \begin{array}{rcll}
        \mathit{var\_id}^\mathrm{lex}
        &\Coloneq &\mathit{id\_small\_char}^\mathrm{lex}\; \mathit{id\_char}^\mathrm{lex}{*}\; \mathop{!} \mathit{id\_char}^\mathrm{lex} \\
        \mathit{con\_id}^\mathrm{lex}
        &\Coloneq &\mathit{id\_large\_char}^\mathrm{lex}\; \mathit{id\_char}^\mathrm{lex}{*}\; \mathop{!} \mathit{id\_char}^\mathrm{lex} \\
        \mathit{var\_sym}^\mathrm{lex}
        &\Coloneq &\mathit{sym\_normal\_char}^\mathrm{lex}\; \mathit{sym\_char}^\mathrm{lex}{*}\; \mathop{!} \mathit{sym\_char}^\mathrm{lex} \\
        \mathit{con\_sym}^\mathrm{lex}
        &\Coloneq &\mathit{sym\_sp\_char}^\mathrm{lex}\; \mathit{sym\_char}^\mathrm{lex}{*}\; \mathop{!} \mathit{sym\_char}^\mathrm{lex} \\
        \mathit{free\_id}^\mathrm{lex}
        &\Coloneq &\mathit{keyword\_prefix\_char}^\mathrm{lex}\; \mathit{string}^\mathrm{lex}
    \end{array}
\end{align*}

Reserved:

\begin{align*}
    \begin{array}{rcll}
        \mathit{keyword\_prefixed}^\mathrm{lex}
        &\Coloneq &\mathit{keyword\_prefix\_char}^\mathrm{lex}\; \mathit{id\_char}^\mathrm{lex}{+}\; \mathop{!} \mathit{id\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{keyword\_prefix\_char}^\mathrm{lex}\; \mathit{sym\_char}^\mathrm{lex}{+}\; \mathop{!} \mathit{sym\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{keyword\_prefix\_char}^\mathrm{lex}\; (\texttt{"\{"} \mathrel{/} \texttt{"["} \mathrel{/} \texttt{"("}) \\
        \mathit{keyword\_id}^\mathrm{lex}
        &\Coloneq &\mathit{keyword\_id\_unit}^\mathrm{lex}\; \mathop{!} \mathit{id\_char}^\mathrm{lex} \\
        \mathit{keyword\_id\_unit}^\mathrm{lex}
        &\Coloneq &\texttt{"\_"} \\
        \mathit{keyword\_sym}^\mathrm{lex}
        &\Coloneq &\mathit{keyword\_sym\_unit}^\mathrm{lex}\; \mathop{!} \mathit{sym\_char}^\mathrm{lex} \\
        \mathit{keyword\_sym\_unit}^\mathrm{lex}
        &\Coloneq &\texttt{"="} \\
        &\mathrel{/} &\texttt{"\^{}"} \\
        &\mathrel{/} &\texttt{":"} \\
        &\mathrel{/} &\texttt{"\textbackslash"}
    \end{array}
\end{align*}

Literal Overview:

\begin{align*}
    \begin{array}{rcll}
        \mathit{literal\_part}^\mathrm{lex}
        &\Coloneq &\mathit{interp\_string\_part}^\mathrm{lex} \\
        \mathit{literal}^\mathrm{lex}
        &\Coloneq &\mathit{string}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{rational}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{integer}^\mathrm{lex}
    \end{array}
\end{align*}

Number Literal:

\begin{align*}
    \begin{array}{rcll}
        \mathit{rational}^\mathrm{lex}
        &\Coloneq &\mathit{sign\_char}^\mathrm{lex}{?}\; (\mathop{!} \mathit{zero\_char}^\mathrm{lex})\; \mathit{decimal}^\mathrm{lex}\; \mathit{num\_dot\_sym\_char}^\mathrm{lex}\; \mathit{decimal}^\mathrm{lex} \\
        \mathit{integer}^\mathrm{lex}
        &\Coloneq &\mathit{number\_prefix}^\mathrm{lex}\; \mathit{hexit\_prefix\_char}^\mathrm{lex}\; \mathit{heximal}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{number\_prefix}^\mathrm{lex}\; \mathit{digit\_prefix\_char}^\mathrm{lex}\; \mathit{decimal}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{sign\_char}^\mathrm{lex}{?}\; (\mathop{!} \mathit{zero\_char}^\mathrm{lex})\; \mathit{decimal}^\mathrm{lex} \\
        \mathit{number\_prefix}^\mathrm{lex}
        &\Coloneq &\mathit{sign\_char}^\mathrm{lex}{?}\; \mathit{zero\_char}^\mathrm{lex} \\
        \mathit{decimal}^\mathrm{lex}
        &\Coloneq &\mathit{digit\_char}^\mathrm{lex}\; \mathit{decimal\_unit\_char}^\mathrm{lex}{*}\; \mathop{!} \mathit{decimal\_unit\_char}^\mathrm{lex} \\
        \mathit{decimal\_unit\_char}^\mathrm{lex}
        &\Coloneq &\mathit{digit\_char}^\mathrm{lex} \mathrel{/} \mathit{num\_sep\_sym\_char}^\mathrm{lex} \\
        \mathit{heximal}^\mathrm{lex}
        &\Coloneq &\mathit{hexit\_char}^\mathrm{lex}\; \mathit{heximal\_unit\_char}^\mathrm{lex}{*}\; \mathop{!} \mathit{heximal\_unit\_char}^\mathrm{lex} \\
        \mathit{heximal\_unit\_char}^\mathrm{lex}
        &\Coloneq &\mathit{hexit\_char}^\mathrm{lex} \mathrel{/} \mathit{num\_sep\_sym\_char}^\mathrm{lex} \\
        \mathit{sign\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"+"} \\
        &\mathrel{/} &\texttt{"-"} \\
        \mathit{zero\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash p\{Digit=0\}"} \\
        \mathit{num\_dot\_sym\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"."} \\
        \mathit{num\_sep\_sym\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\_"} \\
        \mathit{hexit\_char}^\mathrm{lex}
        &\Coloneq &\mathit{digit\_char}^\mathrm{lex} \\
        &\mathrel{/} &\texttt{"A"} \mathrel{/} \texttt{"B"} \mathrel{/} \cdots \mathrel{/} \texttt{"F"} \\
        &\mathrel{/} &\texttt{"a"} \mathrel{/} \texttt{"b"} \mathrel{/} \cdots \mathrel{/} \texttt{"f"} \\
        \mathit{hexit\_prefix\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"x"} \mathrel{/} \texttt{"X"} \\
        \mathit{digit\_prefix\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"d"} \mathrel{/} \texttt{"D"}
    \end{array}
\end{align*}

String Literal:

\begin{align*}
    \begin{array}{rcll}
        \mathit{interp\_string\_part}^\mathrm{lex}
        &\Coloneq &\mathit{interp\_string\_start}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{interp\_string\_cont}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{interp\_string\_end}^\mathrm{lex} \\
        \mathit{string}^\mathrm{lex}
        &\Coloneq &\mathit{string\_sep\_char}^\mathrm{lex}\; \mathit{interp\_string\_graphic}^\mathrm{lex}{*}\; \mathit{string\_sep\_char}^\mathrm{lex} \\
        \mathit{interp\_string\_start}^\mathrm{lex}
        &\Coloneq &\mathit{string\_sep\_char}^\mathrm{lex}\; \mathit{interp\_string\_graphic}^\mathrm{lex}{*}\; \mathit{interp\_open}^\mathrm{lex} \\
        \mathit{interp\_string\_cont}^\mathrm{lex}
        &\Coloneq &\mathit{interp\_close}^\mathrm{lex}\; \mathit{interp\_string\_graphic}^\mathrm{lex}{*}\; \mathit{interp\_open}^\mathrm{lex} \\
        \mathit{interp\_string\_end}^\mathrm{lex}
        &\Coloneq &\mathit{interp\_close}^\mathrm{lex}\; \mathit{interp\_string\_graphic}^\mathrm{lex}{*}\; \mathit{string\_sep\_char}^\mathrm{lex} \\
        \mathit{interp\_open}^\mathrm{lex}
        &\Coloneq &\mathit{interp\_open\_char}^\mathrm{lex}\; \texttt{"\{"} \\
        \mathit{interp\_close}^\mathrm{lex}
        &\Coloneq &\mathit{keyword\_prefix\_char}^\mathrm{lex}\; \texttt{"\}"} \\
        \mathit{escape\_open\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash"} \\
        \mathit{interp\_open\_char}^\mathrm{lex}
        &\Coloneq &\mathit{keyword\_prefix\_char}^\mathrm{lex} \\
        \mathit{interp\_string\_graphic}^\mathrm{lex}
        &\Coloneq &\mathit{uni\_escape}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{bstr\_graphic}^\mathrm{lex} \\
        \mathit{bstr\_graphic}^\mathrm{lex}
        &\Coloneq &\mathit{byte\_escape}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{char\_escape}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{bstr\_graphic\_char}^\mathrm{lex} \\
        \mathit{bstr\_graphic\_char}^\mathrm{lex}
        &\Coloneq &\mathit{white\_char}^\mathrm{lex} \\
        &\mathrel{/} &(\mathop{!} (\mathit{escape\_open\_char}^\mathrm{lex} \mathrel{/} \mathit{string\_sep\_char}^\mathrm{lex} \mathrel{/} \mathit{interp\_open\_char}^\mathrm{lex}))\; \mathit{graphic\_char}^\mathrm{lex} \\
        \mathit{uni\_escape}^\mathrm{lex}
        &\Coloneq &\mathit{escape\_open\_char}^\mathrm{lex}\; \mathit{unicode\_prefix\_char}^\mathrm{lex}\; \texttt{"\{"}\; \mathit{hexit\_char}^\mathrm{lex}{+}\; \texttt{"\}"} \\
        \mathit{byte\_escape}^\mathrm{lex}
        &\Coloneq &\mathit{escape\_open\_char}^\mathrm{lex}\; \mathit{hexit\_prefix\_char}^\mathrm{lex}\; \mathit{hexit\_char}^\mathrm{lex}\; \mathit{hexit\_char}^\mathrm{lex} \\
        \mathit{char\_escape}^\mathrm{lex}
        &\Coloneq &\mathit{escape\_open\_char}^\mathrm{lex}\; \mathit{charesc\_char}^\mathrm{lex} \\
        \mathit{charesc\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"0"} \mathrel{/} \texttt{"a"} \mathrel{/} \texttt{"b"} \mathrel{/} \texttt{"f"} \mathrel{/} \texttt{"n"} \mathrel{/} \texttt{"r"} \mathrel{/} \texttt{"t"} \mathrel{/} \texttt{"v"} \\
        &\mathrel{/} &\mathit{escape\_open\_char}^\mathrm{lex} \mathrel{/} \mathit{string\_sep\_char}^\mathrm{lex} \mathrel{/} \mathit{interp\_open\_char}^\mathrm{lex} \\
        \mathit{unicode\_prefix\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"u"} \mathrel{/} \texttt{"U"}
    \end{array}
\end{align*}

White Space:

\begin{align*}
    \begin{array}{rcll}
        \mathit{whitespace}^\mathrm{lex}
        &\Coloneq &\mathit{whitestuff}^\mathrm{lex}{+} \\
        \mathit{whitestuff}^\mathrm{lex}
        &\Coloneq &\mathit{white\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{comment}^\mathrm{lex}
    \end{array}
\end{align*}

Comment:

\begin{align*}
    \begin{array}{rcll}
        \mathit{comment}^\mathrm{lex}
        &\Coloneq &\mathit{line\_comment}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{multiline\_comment}^\mathrm{lex} \\
        \mathit{line\_comment}^\mathrm{lex}
        &\Coloneq &\mathit{line\_comment\_open}^\mathrm{lex}\; \mathit{any\_1l\_char}^\mathrm{lex}{*}\; (\mathit{newline}^\mathrm{lex} \mathrel{/} \mathbf{EOS}^\mathrm{lex}) \\
        \mathit{multiline\_comment}^\mathrm{lex}
        &\Coloneq &\mathit{multiline\_comment\_open}^\mathrm{lex}; \mathit{anys}^\mathrm{lex}\; (\mathit{multiline\_comment\_close}^\mathrm{lex} \mathrel{/} \mathbf{EOS}^\mathrm{lex}) \\
        \mathit{line\_comment\_open}^\mathrm{lex}
        &\Coloneq &\texttt{"//"} \\
        \mathit{multiline\_comment\_open}^\mathrm{lex}
        &\Coloneq &\texttt{"/*"} \\
        \mathit{multiline\_comment\_close}^\mathrm{lex}
        &\Coloneq &\texttt{"*/"} \\
        \mathit{any\_1l\_char}^\mathrm{lex}
        &\Coloneq &\mathit{graphic\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{space\_char}^\mathrm{lex} \\
        \mathit{anys}^\mathrm{lex}
        &\Coloneq &((\mathop{!} \mathit{multiline\_comment\_close}^\mathrm{lex})\; \mathit{any\_char}^\mathrm{lex}){*} \\
        \mathit{any\_char}^\mathrm{lex}
        &\Coloneq &\mathit{graphic\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{white\_char}^\mathrm{lex}
    \end{array}
\end{align*}

Base Unit:

\begin{align*}
    \begin{array}{rcll}
        \mathit{graphic\_char}^\mathrm{lex}
        &\Coloneq &\mathit{small\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{large\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{symbol\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{digit\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{other\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{special\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{other\_graphic\_char}^\mathrm{lex} \\
        \mathit{id\_char}^\mathrm{lex}
        &\Coloneq &\mathit{id\_small\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{id\_large\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{digit\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{other\_char}^\mathrm{lex} \\
        \mathit{id\_small\_char}^\mathrm{lex}
        &\Coloneq &\mathit{small\_char}^\mathrm{lex} \\
        \mathit{id\_large\_char}^\mathrm{lex}
        &\Coloneq &\mathit{large\_char}^\mathrm{lex} \\
        \mathit{sym\_char}^\mathrm{lex}
        &\Coloneq &\mathit{sym\_normal\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{sym\_sp\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{other\_char}^\mathrm{lex} \\
        \mathit{sym\_normal\_char}^\mathrm{lex}
        &\Coloneq &(\mathop{!} \mathit{sym\_sp\_char}^\mathrm{lex})\; \mathit{symbol\_char}^\mathrm{lex} \\
        \mathit{sym\_sp\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textasciitilde"} \\
        \mathit{white\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash v"} \\
        &\mathrel{/} &\mathit{space\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{newline\_char}^\mathrm{lex} \\
        \mathit{space\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash t"} \\
        &\mathrel{/} &\texttt{"\textbackslash u\{200E\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash u\{200F\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Space\_Separator\}"} \\
        \mathit{newline}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash r\textbackslash n"} \\
        &\mathrel{/} &\mathit{newline\_char}^\mathrm{lex} \\
        \mathit{newline\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash r"} \\
        &\mathrel{/} &\texttt{"\textbackslash n"} \\
        &\mathrel{/} &\texttt{"\textbackslash f"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Line\_Separator\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Paragraph\_Separator\}"}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{small\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash p\{General\_Category=Lowercase\_Letter\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Other\_Letter\}"} \\
        &\mathrel{/} &\texttt{"\_"} \\
        \mathit{large\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash p\{General\_Category=Uppercase\_Letter\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Titlecase\_Letter\}"} \\
        \mathit{symbol\_char}^\mathrm{lex}
        &\Coloneq &(\mathop{!} (\mathit{special\_char}^\mathrm{lex} \mathrel{/} "\_"))\; \mathit{symbol\_cat\_char}^\mathrm{lex} \\
        \mathit{symbol\_cat\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash p\{General\_Category=Connector\_Punctuation\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Dash\_Punctuation\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Other\_Punctuation\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Symbol\}"} \\
        \mathit{digit\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash p\{General\_Category=Decimal\_Number\}"} \\
        \mathit{other\_char}^\mathrm{lex}
        &\Coloneq &(\mathop{!} \mathit{white\_char}^\mathrm{lex})\; \mathit{other\_cat\_char}^\mathrm{lex} \\
        \mathit{other\_cat\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash p\{General\_Category=Modifier\_Letter\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Mark\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Letter\_Number\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Other\_Number\}"} \\
        &\mathrel{/} &\texttt{"\textbackslash p\{General\_Category=Format\}"}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{special\_char}^\mathrm{lex}
        &\Coloneq &\mathit{delimit\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{special\_prefix\_char}^\mathrm{lex} \\
        \mathit{delimit\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\{"} \\
        &\mathrel{/} &\texttt{"\}"} \\
        &\mathrel{/} &\texttt{"["} \\
        &\mathrel{/} &\texttt{"]"} \\
        &\mathrel{/} &\texttt{"("} \\
        &\mathrel{/} &\texttt{")"} \\
        &\mathrel{/} &\texttt{";"} \\
        &\mathrel{/} &\texttt{".""} \\
        \mathit{special\_prefix\_char}^\mathrm{lex}
        &\Coloneq &\mathit{keyword\_prefix\_char}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{string\_sep\_char}^\mathrm{lex} \\
        &\mathrel{/} &\texttt{"'"} \\
        \mathit{keyword\_prefix\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\#"} \\
        \mathit{string\_sep\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash \textbackslash "} \\
        \mathit{other\_graphic\_char}^\mathrm{lex}
        &\Coloneq &(\mathop{!} (\mathit{symbol\_cat\_char}^\mathrm{lex} \mathrel{/} \mathit{special\_char}^\mathrm{lex}))\; \mathit{other\_graphic\_cat\_char}^\mathrm{lex} \\
        \mathit{other\_graphic\_cat\_char}^\mathrm{lex}
        &\Coloneq &\texttt{"\textbackslash p\{General\_Category=Punctuation\}"}
    \end{array}
\end{align*}

\section{Layout Processing}

Pre-Process:

\begin{algorithmic}[1]
    \Procedure{PRE\_PARSE}{}
        \State{$\mathit{pre\_line} \assign 1$}
        \State{$\mathit{should\_open\_imp\_layout} \assign \top$}
        \Comment{Insert the top-level implicit layout.}
        \While{$(\mathit{current\_token}, \mathit{current\_line}, \mathit{current\_col}) \assign \mathbf{consume}$}
            \If{$\mathit{current\_token} \not\in \mathcal{A}_{\mathit{lexeme}^\mathrm{lex}}$}
                \State{$\mathbf{continue}$}
                \Comment{Skip white-spaces.}
            \EndIf
            \If{$\mathit{should\_open\_imp\_layout}$}
                \State{$\mathbf{yield}\; \{\mathrm{open\_imp}(\mathit{current\_col})\}$}
                \State{$\mathit{should\_open\_imp\_layout} \assign \bot$}
            \EndIf
            \If{$\mathit{pre\_line} < \mathit{current\_line}$}
                \State{$\mathbf{yield}\; \{\mathrm{newline}(\mathit{current\_col})\}$}
                \State{$\mathit{pre\_line} \assign \mathit{current\_line}$}
            \EndIf
            \State{$\mathbf{yield}\; \mathit{current\_token}$}
            \If{$\mathit{current\_token} \in \mathcal{A}_{\mathit{lb\_imp\_open}^\mathrm{lex}} \cup \mathcal{A}_{\mathit{lp\_imp\_open}^\mathrm{lex}}$}
                \State{$\mathit{should\_open\_imp\_layout} \assign \top$}
            \ElsIf{$\mathit{current\_token} \in \mathcal{A}_{\mathit{lb\_exp\_open}^\mathrm{lex}} \cup \mathcal{A}_{\mathit{lp\_exp\_open}^\mathrm{lex}}$}
                \State{$\mathbf{yield}\; \{\mathrm{open\_exp}\}$}
            \ElsIf{$\mathit{current\_token} \in \mathcal{A}_{\mathit{lb\_close}^\mathrm{lex}} \cup \mathcal{A}_{\mathit{lp\_close}^\mathrm{lex}}$}
                \State{$\mathbf{yield}\; \{\mathrm{close}\}$}
            \EndIf
        \EndWhile
        \If{$\mathit{should\_open\_imp\_layout}$}
            \State{$\mathbf{yield}\; \{\mathrm{open\_imp}(0)\}$}
            \State{$\mathit{should\_open\_imp\_layout} \assign \bot$}
        \EndIf
        \State{$\mathbf{yield}\; \{\mathrm{close}\}$}
    \EndProcedure
\end{algorithmic}

Add Layout Tokens:

\begin{algorithmic}[1]
    \Procedure{WITH\_LAYOUT\_TOKEN}{}
        \State{$\mathit{layout\_stack} \assign []$}
        \While{$\mathit{current\_token} \assign \mathbf{consume}$}
            \If{$\{\mathrm{open\_imp}(m)\} \assign \mathit{current\_token}$}
                \State{$\mathit{layout\_stack}.\mathbf{push}(\{m\})$}
            \ElsIf{$\{\mathrm{open\_exp}\} \assign \mathit{current\_token}$}
                \State{$\mathit{layout\_stack}.\mathbf{push}(\{-\})$}
            \ElsIf{$\{\mathrm{close}\} \assign \mathit{current\_token}$}
                \If{$\mathit{layout\_stack}.\mathbf{is\_empty}()$}
                    \State{$\mathbf{error}$}
                    \Comment{Too many layout closing.}
                \Else
                    \State{$\mathit{layout\_stack}.\mathbf{pop}()$}
                \EndIf
            \ElsIf{$\{\mathrm{newline}(c)\} \assign \mathit{current\_token}$}
                \If{$\mathit{layout\_stack}.\mathbf{is\_empty}()$}
                    \State{$\mathbf{error}$}
                    \Comment{Too early layout closing.}
                \ElsIf{$\{m\} \assign \mathit{layout\_stack}.\mathbf{get}()$}
                    \If{$c < m$}
                        \State{$\mathbf{error}$}
                        \Comment{Less indentation in the current implicit layout.}
                    \ElsIf{$c = m$}
                        \State{$\mathbf{yield}\;\texttt{<;>}$}
                    \ElsIf{$c > m$}
                        \State{$\mathbf{continue}$}
                    \EndIf
                \ElsIf{$\{-\} \assign \mathit{layout\_stack}.\mathbf{get}()$}
                    \State{$\mathbf{continue}$}
                    \Comment{Skip newlines in explicit layouts.}
                \EndIf
            \Else
                \State{$\mathbf{yield}\;\mathit{current\_token}$}
            \EndIf
        \EndWhile
    \EndProcedure
\end{algorithmic}

\section{Parsing Structure}

Program:

\begin{align*}
    \begin{array}{rcll}
        \mathit{program}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{program\_body}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{program\_body}^\mathrm{parse} \\
        \mathit{program\_body}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{decl}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{decl}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?}
    \end{array}
\end{align*}

Declaration:

\begin{align*}
    \begin{array}{rcll}
        \mathit{decl}^\mathrm{parse}
        &\Coloneq &\mathit{decl\_func}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bind\_prom\_type}^\mathrm{parse} \\
        \mathit{decl\_func}^\mathrm{parse}
        &\Coloneq &\texttt{"\#fun"}\; \mathit{declvar}^\mathrm{parse}\; \mathit{type\_tuple\_sig}^\mathrm{parse}\; \mathit{decl\_sig}^\mathrm{parse}{?}\; \texttt{"="}\; \mathit{expr}^\mathrm{parse} \\
        \mathit{decl\_sig}^\mathrm{parse}
        &\Coloneq &\texttt{":"}\; \mathit{type}^\mathrm{parse}
    \end{array}
\end{align*}

Local Declaration:

\begin{align*}
    \begin{array}{rcll}
        \mathit{local\_decl}^\mathrm{parse}
        &\Coloneq &\texttt{"\#let"}\; \mathit{let\_body}^\mathrm{parse} \\
        &\mathrel{/} &\texttt{"\#rec"}\; \mathit{let\_body}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{decl\_func}^\mathrm{parse} \\
        \mathit{local\_type\_decl}^\mathrm{parse}
        &\Coloneq &\texttt{"\#let"}\; \mathit{let\_type\_body}^\mathrm{parse} \\
        \mathit{let\_body}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{let\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{let\_item}^\mathrm{parse} \\
        \mathit{let\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{let\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{let\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{let\_item}^\mathrm{parse}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bind\_expr}^\mathrm{parse} \\
        \mathit{let\_type\_body}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{let\_type\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{let\_type\_item}^\mathrm{parse} \\
        \mathit{let\_type\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{let\_type\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{let\_type\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{let\_type\_item}^\mathrm{parse}
        &\Coloneq & \mathit{bind\_prom\_type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bind\_type}^\mathrm{parse}
    \end{array}
\end{align*}

Where Declaration:

\begin{align*}
    \begin{array}{rcll}
        \mathit{where\_decl}^\mathrm{parse}
        &\Coloneq &\texttt{"\#where"}\; \mathit{where\_body}^\mathrm{parse} \\
        \mathit{where\_body}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{where\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{where\_item}^\mathrm{parse} \\
        \mathit{where\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{where\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{where\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{where\_item}^\mathrm{parse}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bind\_expr}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{local\_decl}^\mathrm{parse} \\
        \mathit{bind\_expr}^\mathrm{parse}
        &\Coloneq &\mathit{bindvar}^\mathrm{parse}\; \mathit{decl\_sig}^\mathrm{parse}{?}\; \texttt{"="}\; \mathit{expr}^\mathrm{parse} \\
        \mathit{bind\_type}^\mathrm{parse}
        &\Coloneq &\mathit{bindvar}^\mathrm{parse}\; \mathit{decl\_sig}^\mathrm{parse}{?}\; \texttt{"="}\; \mathit{type}^\mathrm{parse} \\
        \mathit{bind\_prom\_type}^\mathrm{parse}
        &\Coloneq &\texttt{"\^{}"}\; \mathit{bindvar}^\mathrm{parse}\; \mathit{decl\_sig}^\mathrm{parse}{?}\; \texttt{"="}\; \mathit{type}^\mathrm{parse}
    \end{array}
\end{align*}

Expression:

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr}^\mathrm{parse}
        &\Coloneq &\mathit{expr\_ann}^\mathrm{parse}\; \mathit{where\_decl}^\mathrm{parse}{*} \\
        \mathit{expr\_ann}^\mathrm{parse}
        &\Coloneq &\mathit{expr\_infix}^\mathrm{parse}\; \texttt{":"}\; \mathit{type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{expr\_infix}^\mathrm{parse} \\
        \mathit{expr\_infix}^\mathrm{parse}
        &\Coloneq &\mathit{expr\_apps}^\mathrm{parse}\; (\mathit{expr\_op}^\mathrm{parse}\; \mathit{expr\_apps}^\mathrm{parse}){*} \\
        \mathit{expr\_op}^\mathrm{parse}
        &\Coloneq &\texttt{"\#op"}\; \mathit{lp\_open}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{expr}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{lp\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{sym}^\mathrm{parse} \\
        \mathit{expr\_apps}^\mathrm{parse}
        &\Coloneq &\mathit{expr\_struct}^\mathrm{parse}\; \mathit{expr\_app\_arg}^\mathrm{parse}{*} \\
        \mathit{expr\_app\_arg}^\mathrm{parse}
        &\Coloneq &\mathit{expr\_tuple}^\mathrm{parse} \\
        \mathit{expr\_struct}^\mathrm{parse}
        &\Coloneq &\texttt{"\textbackslash"}\; \mathit{expr}^\mathrm{parse} \\
        &\mathrel{/} &\texttt{"\#match"}\; \mathit{expr\_tuple\_items}^\mathrm{parse}\; \texttt{"\#in"}\; \mathit{expr}^\mathrm{parse} \\
        &\mathrel{/} &\texttt{"\#case"}\; \mathit{case\_body}^\mathrm{parse} \\
        &\mathrel{/} &\texttt{"\#when"}\; \mathit{case\_body}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{expr\_atomic}^\mathrm{parse} \\
        \mathit{expr\_atomic}^\mathrm{parse}
        &\Coloneq &\mathit{expr\_proc}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{expr\_block}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{literal}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{expr\_interp\_string}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{expr\_tuple}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{con}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{var}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{case\_body}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{case\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{case\_item}^\mathrm{parse} \\
        \mathit{case\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{case\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{case\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{case\_item}^\mathrm{parse}
        &\Coloneq &\mathit{view}^\mathrm{parse}\; \texttt{"\#-"}\; \mathit{expr}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_proc}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{expr\_proc\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        \mathit{expr\_proc\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{expr\_proc\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{expr\_proc\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{expr\_proc\_item}^\mathrm{parse}
        &\Coloneq &\mathit{pat\_tuple\_items}^\mathrm{parse}\; \mathit{pat\_guard}^\mathrm{parse}{?}\; \texttt{"\#-"}\; \mathit{expr}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_block}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{expr\_block\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        \mathit{expr\_block\_items}^\mathrm{parse}
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{expr\_block\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{expr\_block\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{expr\_block\_item}^\mathrm{parse}
        &\Coloneq &\mathit{expr}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{local\_decl}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_interp\_string}^\mathrm{parse}
        &\Coloneq &\mathit{interp\_string\_start}^\mathrm{parse}\; \mathit{expr\_interp\_string\_items}^\mathrm{parse}\; \mathit{interp\_string\_end}^\mathrm{parse} \\
        \mathit{expr\_interp\_string\_items}^\mathrm{parse}
        &\Coloneq &\mathit{expr\_block\_items}^\mathrm{parse}\; \mathit{expr\_interp\_string\_item}^\mathrm{parse}{*} \\
        \mathit{expr\_interp\_string\_item}^\mathrm{parse}
        &\Coloneq &\mathit{interp\_string\_cont}^\mathrm{parse}\; \mathit{expr\_block\_items}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_tuple}^\mathrm{parse}
        &\Coloneq &\mathit{lp\_open}^\mathrm{parse}\; \mathit{expr\_tuple\_items}^\mathrm{parse}\; \mathit{lp\_close}^\mathrm{parse} \\
        \mathit{expr\_tuple\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{expr\_tuple\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{expr\_tuple\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{expr\_tuple\_item}^\mathrm{parse}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bind\_expr}^\mathrm{parse} \\
        &\mathrel{/} &\texttt{"\^{}"}\; \mathit{type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{expr}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{local\_decl}^\mathrm{parse}
    \end{array}
\end{align*}

Type Expression:

\begin{align*}
    \begin{array}{rcll}
        \mathit{type}^\mathrm{parse}
        &\Coloneq &\mathit{type\_ann}^\mathrm{parse}\; \mathit{where\_decl}^\mathrm{parse}{*} \\
        \mathit{type\_ann}^\mathrm{parse}
        &\Coloneq &\mathit{type\_infix}^\mathrm{parse}\; \texttt{":"}\; \mathit{type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{type\_infix}^\mathrm{parse} \\
        \mathit{type\_infix}^\mathrm{parse}
        &\Coloneq &\mathit{type\_apps}^\mathrm{parse}\; (\mathit{type\_op}^\mathrm{parse}\; \mathit{type\_apps}^\mathrm{parse}){*} \\
        \mathit{type\_op}^\mathrm{parse}
        &\Coloneq &\texttt{"\#op"}\; \mathit{lp\_open}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{type}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{lp\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{sym}^\mathrm{parse} \\
        \mathit{type\_apps}^\mathrm{parse}
        &\Coloneq &\mathit{type\_atomic}^\mathrm{parse}\; \mathit{type\_app\_arg}^\mathrm{parse}{*} \\
        \mathit{type\_app\_arg}^\mathrm{parse}
        &\Coloneq &\mathit{type\_tuple}^\mathrm{parse} \\
        \mathit{type\_atomic}^\mathrm{parse}
        &\Coloneq &\mathit{type\_block}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{literal}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{type\_literal}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{type\_func\_sig}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{type\_block\_sig}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{type\_tuple}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{type\_tuple\_sig}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{con}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{var}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_block}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{type\_block\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        \mathit{type\_block\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{type\_block\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{type\_block\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{type\_block\_item}^\mathrm{parse}
        &\Coloneq &\mathit{type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{local\_type\_decl}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_literal}^\mathrm{parse}
        &\Coloneq &\texttt{"\#Type"} \\
        &\mathrel{/} &\texttt{"\#String"} \\
        &\mathrel{/} &\texttt{"\#Integer"} \\
        &\mathrel{/} &\texttt{"\#Rational"} \\
        &\mathrel{/} &\texttt{"\#Proc"}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_func\_sig}^\mathrm{parse}
        &\Coloneq &\mathit{type\_tuple\_sig}^\mathrm{parse}\; \texttt{"\#>"}\; \mathit{type}^\mathrm{parse} \\
        \mathit{type\_block\_sig}^\mathrm{parse}
        &\Coloneq &\mathit{type\_tuple\_sig}^\mathrm{parse}\; \texttt{"\#-|"}\; \mathit{type}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_tuple}^\mathrm{parse}
        &\Coloneq &\mathit{lp\_open}^\mathrm{parse}\; \mathit{type\_tuple\_items}^\mathrm{parse}\; \mathit{lp\_close}^\mathrm{parse} \\
        \mathit{type\_tuple\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{type\_tuple\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{type\_tuple\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{type\_tuple\_item}^\mathrm{parse}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bind\_type}^\mathrm{parse} \\
        &\mathrel{/} &\texttt{"\^{}"}\; \mathit{type\_infix}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{type\_infix}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{local\_type\_decl}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_tuple\_sig}^\mathrm{parse}
        &\Coloneq &\mathit{lp\_open}^\mathrm{parse}\; \mathit{type\_tuple\_sig\_items}^\mathrm{parse}\; \mathit{lp\_close}^\mathrm{parse} \\
        \mathit{type\_tuple\_sig\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{type\_tuple\_sig\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{type\_tuple\_sig\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{type\_tuple\_sig\_item}^\mathrm{parse}
        &\Coloneq &\texttt{"\^{}"}\; \mathit{bindvar}^\mathrm{parse}\; \texttt{":"}\; \mathit{type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bindvar}^\mathrm{parse}\; \texttt{":"}\; \mathit{type}^\mathrm{parse}
    \end{array}
\end{align*}

Pattern:

\begin{align*}
    \begin{array}{rcll}
        \mathit{pat}^\mathrm{parse}
        &\Coloneq &\mathit{pat\_ann}^\mathrm{parse}\; \mathit{pat\_guard}^\mathrm{parse}{*} \\
        \mathit{pat\_guard}^\mathrm{parse}
        &\Coloneq &\texttt{"\#if"}\; \mathit{view}^\mathrm{parse} \\
        \mathit{pat\_ann}^\mathrm{parse}
        &\Coloneq &\mathit{pat\_infix}^\mathrm{parse}\; \texttt{":"}\; \mathit{type}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{pat\_infix}^\mathrm{parse} \\
        \mathit{pat\_infix}^\mathrm{parse}
        &\Coloneq &\mathit{pat\_apps}^\mathrm{parse}\; (\mathit{pat\_op}^\mathrm{parse}\; \mathit{pat\_apps}^\mathrm{parse}){*} \\
        \mathit{pat\_op}^\mathrm{parse}
        &\Coloneq &\texttt{"\#op"}\; \mathit{lp\_open}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{con}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{lp\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{con\_sym}^\mathrm{lex} \\
        \mathit{pat\_apps}^\mathrm{parse}
        &\Coloneq &\mathit{con}^\mathrm{parse}\; \mathit{pat\_app\_arg}^\mathrm{parse}{*} \\
        \mathit{pat\_app\_arg}^\mathrm{parse}
        &\Coloneq &\mathit{pat\_tuple}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{pat\_atomic}^\mathrm{parse} \\
        \mathit{pat\_atomic}^\mathrm{parse}
        &\Coloneq &\mathit{pat\_block}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{literal}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{pat\_tuple}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{bindvar}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{pat\_block}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{pat\_block\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        \mathit{pat\_block\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; (\mathit{view\_block\_item}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}){*}\; \mathit{pat}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{pat\_tuple}^\mathrm{parse}
        &\Coloneq &\mathit{lp\_open}^\mathrm{parse}\; \mathit{pat\_tuple\_items}^\mathrm{parse}\; \mathit{lp\_close}^\mathrm{parse} \\
        \mathit{pat\_tuple\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{pat\_tuple\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{pat\_tuple\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{pat\_tuple\_item}^\mathrm{parse}
        &\Coloneq &\mathit{declvar}^\mathrm{parse}\; \texttt{"="}\; \mathit{pat}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{pat}^\mathrm{parse}
    \end{array}
\end{align*}

View:

\begin{align*}
    \begin{array}{rcll}
        \mathit{view}^\mathrm{parse}
        &\Coloneq &\mathit{view\_block}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{view\_bind}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{expr}^\mathrm{parse} \\
        \mathit{view\_bind}^\mathrm{parse}
        &\Coloneq &\mathit{pat}^\mathrm{parse}\; \texttt{"="}\; \mathit{expr}^\mathrm{parse}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{view\_block}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{view\_block\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        \mathit{view\_block\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{view\_block\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{view\_block\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{view\_block\_item}^\mathrm{parse}
        &\Coloneq &\texttt{"\#let"}\; \mathit{view\_let\_body}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{view}^\mathrm{parse} \\
        \mathit{view\_let\_body}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_open}^\mathrm{parse}\; \mathit{view\_let\_items}^\mathrm{parse}\; \mathit{lb\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{view\_let\_item}^\mathrm{parse} \\
        \mathit{view\_let\_items}^\mathrm{parse}
        &\Coloneq &\mathit{lsemis}^\mathrm{parse}{?}\; \mathit{view\_let\_item}^\mathrm{parse}\; (\mathit{lsemis}^\mathrm{parse}\; \mathit{view\_let\_item}^\mathrm{parse}){*}\; \mathit{lsemis}^\mathrm{parse}{?} \\
        &\mathrel{/} &\mathit{lsemis}^\mathrm{parse}{?} \\
        \mathit{view\_let\_item}^\mathrm{parse}
        &\Coloneq &\mathit{view\_bind}^\mathrm{parse}
    \end{array}
\end{align*}

Base Unit:

\begin{align*}
    \begin{array}{rcll}
        \mathit{declvar}^\mathrm{parse}
        &\Coloneq &\texttt{"\#id"}\; \mathit{lp\_open}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; (\mathit{var\_sym}^\mathrm{lex}\; \mathrel{/} \mathit{var\_id}^\mathrm{lex})\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{lp\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{var\_id}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{free\_id}^\mathrm{lex} \\
        \mathit{bindvar}^\mathrm{parse}
        &\Coloneq &\mathit{declvar}^\mathrm{parse} \\
        &\mathrel{/} &\texttt{"\_"} \\
        \mathit{sym}^\mathrm{parse}
        &\Coloneq &\mathit{con\_sym}^\mathrm{lex} \\
        &\mathrel{/} &\mathit{var\_sym}^\mathrm{lex} \\
        \mathit{con}^\mathrm{parse}
        &\Coloneq &\texttt{"\#id"}\; \mathit{lp\_open}^\mathrm{parse}\; \mathit{lsemis}^\mathrm{parse}{?}\; (\mathit{con\_sym}^\mathrm{lex}\; \mathrel{/} \mathit{con\_id}^\mathrm{lex})\; \mathit{lsemis}^\mathrm{parse}{?}\; \mathit{lp\_close}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{con\_id}^\mathrm{lex} \\
        \mathit{var}^\mathrm{parse}
        &\Coloneq &\mathit{declvar}^\mathrm{parse}
    \end{array}
\end{align*}

Layout Unit:

\begin{align*}
    \begin{array}{rcll}
        \mathit{lb\_open}^\mathrm{parse}
        &\Coloneq &\mathit{lb\_imp\_open}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{lb\_exp\_open}^\mathrm{parse} \\
        \mathit{lb\_imp\_open}^\mathrm{parse}
        &\Coloneq &\texttt{"\{"} \\
        \mathit{lb\_exp\_open}^\mathrm{parse}
        &\Coloneq &\texttt{"\#\{"} \\
        \mathit{lb\_close}^\mathrm{parse}
        &\Coloneq &\texttt{"\}"} \\
        \mathit{lp\_open}^\mathrm{parse}
        &\Coloneq &\mathit{lp\_imp\_open}^\mathrm{parse} \\
        &\mathrel{/} &\mathit{lp\_exp\_open}^\mathrm{parse} \\
        \mathit{lp\_imp\_open}^\mathrm{parse}
        &\Coloneq &\texttt{"("} \\
        \mathit{lp\_exp\_open}^\mathrm{parse}
        &\Coloneq &\texttt{"\#("} \\
        \mathit{lp\_close}^\mathrm{parse}
        &\Coloneq &\texttt{")"} \\
        \mathit{lsemis}^\mathrm{parse}
        &\Coloneq &(\texttt{<;>}\; \mathrel{/} \texttt{";"}){+}
    \end{array}
\end{align*}

\section{Literal Parsing}

\subsection{Integer}

\subsection{Rational}

\subsection{String}

\section{Identifier Parsing}

\subsection{Normal Identifier}

\subsection{Free Identifier}

\section{Abstract Parsed Tree}

Program:

\begin{align*}
    \begin{array}{rcll}
        \mathit{program}^\mathrm{apt}
        &\Coloneq &\mathrm{\#prog}(\mathit{decl}^\mathrm{apt}*)
    \end{array}
\end{align*}

Declaration:

\begin{align*}
    \begin{array}{rcll}
        \mathit{decl}^\mathrm{apt}
        &\Coloneq &\mathit{decl\_func}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{bind\_prom\_type}^\mathrm{apt} \\
        \mathit{decl\_func}^\mathrm{apt}
        &\Coloneq &\mathrm{\#fun}(\mathit{declvar}^\mathrm{apt}; \mathit{type\_tuple\_sig}^\mathrm{apt}; \mathit{decl\_sig}^\mathrm{apt}; \mathit{expr}^\mathrm{apt}) \\
        \mathit{decl\_sig}^\mathrm{apt}
        &\Coloneq &\mathrm{\#decl\_sig}(\mathit{type}^\mathrm{apt}) \\
        &\mathrel{/} &\mathrm{\#decl\_sig\_nothing}
    \end{array}
\end{align*}

Local Declaration:

\begin{align*}
    \begin{array}{rcll}
        \mathit{local\_decl}^\mathrm{apt}
        &\Coloneq &\mathrm{\#let}(\mathit{let\_item}^\mathrm{apt}{*}) \\
        &\mathrel{/} &\mathrm{\#rec}(\mathit{let\_item}^\mathrm{apt}{*}) \\
        &\mathrel{/} &\mathit{decl\_func}^\mathrm{apt} \\
        \mathit{local\_type\_decl}^\mathrm{apt}
        &\Coloneq &\mathrm{\#let}(\mathit{let\_type\_item}^\mathrm{apt}{*}) \\
        \mathit{let\_item}^\mathrm{apt}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{bind\_expr}^\mathrm{apt} \\
        \mathit{let\_type\_item}^\mathrm{apt}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{bind\_type}^\mathrm{apt}
    \end{array}
\end{align*}

Where Declaration:

\begin{align*}
    \begin{array}{rcll}
        \mathit{where\_decl}^\mathrm{apt}
        &\Coloneq &\mathrm{\#where}(\mathit{where\_item}^\mathrm{apt}{*}) \\
        \mathit{where\_item}^\mathrm{apt}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{bind\_expr}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{local\_decl}^\mathrm{apt} \\
        \mathit{bind\_expr}^\mathrm{apt}
        &\Coloneq &\mathrm{\#bind\_expr}(\mathit{bindvar}^\mathrm{apt}; \mathit{decl\_sig}^\mathrm{apt}; \mathit{expr}^\mathrm{apt}) \\
        \mathit{bind\_type}^\mathrm{apt}
        &\Coloneq &\mathrm{\#bind\_type}(\mathit{bindvar}^\mathrm{apt}; \mathit{decl\_sig}^\mathrm{apt}; \mathit{type}^\mathrm{apt}) \\
        \mathit{bind\_prom\_type}^\mathrm{apt}
        &\Coloneq &\mathrm{\#bind\_prom}(\mathit{bindvar}^\mathrm{apt}; \mathit{decl\_sig}^\mathrm{apt}; \mathit{type}^\mathrm{apt})
    \end{array}
\end{align*}

Expression:

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr}^\mathrm{apt}
        &\Coloneq &\mathit{expr}^\mathrm{apt}\; \mathit{where\_decl}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{expr}^\mathrm{apt}: \mathit{type}^\mathrm{apt} \\
        &\mathrel{/} &\mathrm{\#infix}(\mathit{expr}^\mathrm{apt}; \mathit{expr\_infix\_item}^\mathrm{apt}{+}) \\
        &\mathrel{/} &\mathrm{\#app}(\mathit{expr}^\mathrm{apt}; \mathit{expr\_tuple}^\mathrm{apt}) \\
        &\mathrel{/} &\lambda(\mathit{expr}^\mathrm{apt}) \\
        &\mathrel{/} &\mathrm{\#match}(\mathit{expr\_tuple}^\mathrm{apt}; \mathit{expr}^\mathrm{apt}) \\
        &\mathrel{/} &\mathrm{\#case}(\mathit{case\_body}^\mathrm{apt}) \\
        &\mathrel{/} &\mathrm{\#when}(\mathit{case\_body}^\mathrm{apt}) \\
        &\mathrel{/} &\mathit{expr\_proc}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{expr\_block}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{literal}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{expr\_interp\_string}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{expr\_tuple}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{con}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{var}^\mathrm{apt}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_infix\_item}^\mathrm{apt}
        &\Coloneq &\mathrm{\#infix\_item}(\mathit{expr}^\mathrm{apt}; \mathit{expr}^\mathrm{apt})
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{case\_body}^\mathrm{apt}
        &\Coloneq &\mathrm{\#case\_items}(\mathit{case\_item}^\mathrm{apt}{*}) \\
        \mathit{case\_item}^\mathrm{apt}
        &\Coloneq &\mathrm{\#case\_item}(\mathit{view}^\mathrm{apt}; \mathit{expr}^\mathrm{apt})
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_proc}^\mathrm{apt}
        &\Coloneq &\mathrm{\#proc\_items}(\mathit{expr\_proc\_item}^\mathrm{apt}{*}) \\
        \mathit{expr\_proc\_item}^\mathrm{apt}
        &\Coloneq &\mathrm{\#proc\_item}(\mathit{pat\_tuple}^\mathrm{apt}; \mathit{expr\_proc\_guard}^\mathrm{apt}; \mathit{expr}^\mathrm{apt}) \\
        \mathit{expr\_proc\_guard}^\mathrm{apt}
        &\Coloneq &\mathrm{\#proc\_guard}(\mathit{view}^\mathrm{apt}) \\
        &\mathrel{/} &\mathrm{\#proc\_guard\_nothing}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_block}^\mathrm{apt}
        &\Coloneq &\mathrm{\#block\_items}(\mathit{expr\_block\_item}^\mathrm{apt}{*}) \\
        \mathit{expr\_block\_item}^\mathrm{apt}
        &\Coloneq &\mathit{expr}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{local\_decl}^\mathrm{apt}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_interp\_string}^\mathrm{apt}
        &\Coloneq &\mathit{interp\_string\_start}^\mathrm{apt}\; \mathit{expr\_interp\_string\_items}^\mathrm{apt}\; \mathit{interp\_string\_end}^\mathrm{apt} \\
        \mathit{expr\_interp\_string\_items}^\mathrm{apt}
        &\Coloneq &\mathit{expr\_block}^\mathrm{apt}\; \mathit{expr\_interp\_string\_item}^\mathrm{apt}{*} \\
        \mathit{expr\_interp\_string\_item}^\mathrm{apt}
        &\Coloneq &\mathit{interp\_string\_cont}^\mathrm{apt}\; \mathit{expr\_block}^\mathrm{apt}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{expr\_tuple}^\mathrm{apt}
        &\Coloneq &\mathrm{\#tuple}(\mathit{expr\_tuple\_item}^\mathrm{apt}{*}) \\
        \mathit{expr\_tuple\_item}^\mathrm{apt}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{bind\_expr}^\mathrm{apt} \\
        &\mathrel{/} &\mathrm{\#prom}(\mathit{type}^\mathrm{apt}) \\
        &\mathrel{/} &\mathit{expr}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{local\_decl}^\mathrm{apt}
    \end{array}
\end{align*}

Type Expression:

\begin{align*}
    \begin{array}{rcll}
        \mathit{type}^\mathrm{apt}
        &\Coloneq &\mathit{type}^\mathrm{apt}\; \mathit{where\_decl}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{type}^\mathrm{apt}: \mathit{type}^\mathrm{apt} \\
        &\mathrel{/} &\mathrm{\#infix}(\mathit{type}^\mathrm{apt}; \mathit{type\_infix\_item}^\mathrm{apt}{+}) \\
        &\mathrel{/} &\mathrm{\#app}(\mathit{type}^\mathrm{apt}; \mathit{type\_tuple}^\mathrm{apt}) \\
        &\mathrel{/} &\mathit{type\_block}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{literal}^\mathrm{lit} \\
        &\mathrel{/} &\mathit{type\_literal}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{type\_func\_sig}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{type\_proc\_sig}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{type\_tuple}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{type\_tuple\_sig}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{con}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{var}^\mathrm{apt}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_infix\_item}^\mathrm{apt}
        &\Coloneq &\mathrm{\#infix\_item}(\mathit{type}^\mathrm{apt}; \mathit{type}^\mathrm{apt})
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_block}^\mathrm{apt}
        &\Coloneq &\mathrm{\#block\_items}(\mathit{type\_block\_item}^\mathrm{apt}{*}) \\
        \mathit{type\_block\_item}^\mathrm{apt}
        &\Coloneq &\mathit{type}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{local\_type\_decl}^\mathrm{apt}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_literal}^\mathrm{apt}
        &\Coloneq &\mathrm{\#Type} \\
        &\mathrel{/} &\mathrm{\#String} \\
        &\mathrel{/} &\mathrm{\#Integer} \\
        &\mathrel{/} &\mathrm{\#Rational} \\
        &\mathrel{/} &\mathrm{\#Proc}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_func\_sig}^\mathrm{apt}
        &\Coloneq &\Lambda(\mathit{type\_tuple\_sig}^\mathrm{apt}; \mathit{type}^\mathrm{apt})
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_proc\_sig}^\mathrm{apt}
        &\Coloneq &\mathrm{\#proc\_sig}(\mathit{type\_tuple\_sig}^\mathrm{apt}; \mathit{type}^\mathrm{apt})
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_tuple}^\mathrm{apt}
        &\Coloneq &\mathrm{\#tuple}(\mathit{type\_tuple\_item}^\mathrm{apt}{*}) \\
        \mathit{type\_tuple\_item}^\mathrm{apt}
        &\Coloneq &\mathit{bind\_prom\_type}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{bind\_type}^\mathrm{apt} \\
        &\mathrel{/} &\mathrm{\#prom}(\mathit{type}^\mathrm{apt}) \\
        &\mathrel{/} &\mathit{type}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{local\_type\_decl}^\mathrm{apt}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{type\_tuple\_sig}^\mathrm{apt}
        &\Coloneq &\mathrm{\#tuple\_sig}(\mathit{type\_tuple\_sig\_item}^\mathrm{apt}{*}) \\
        \mathit{type\_tuple\_sig\_item}^\mathrm{apt}
        &\Coloneq &\mathrm{\#prom}(\mathit{bindvar}^\mathrm{apt}; \mathit{type}^\mathrm{apt}) \\
        &\mathrel{/} &\mathit{bindvar}^\mathrm{apt}: \mathit{type}^\mathrm{apt}
    \end{array}
\end{align*}

Pattern:

\begin{align*}
    \begin{array}{rcll}
        \mathit{pat}^\mathrm{apt}
        &\Coloneq &\mathit{pat}^\mathrm{apt}\; \mathrm{\#if}\; \mathit{view}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{pat}^\mathrm{apt}: \mathit{type}^\mathrm{apt} \\
        &\mathrel{/} &\mathrm{\#infix}(\mathit{pat}^\mathrm{apt}; \mathit{con}^\mathrm{apt}; \mathit{pat}^\mathrm{apt}) \\
        &\mathrel{/} &\mathrm{\#app}(\mathit{con}^\mathrm{apt}; \mathit{pat\_tuple}^\mathrm{apt}) \\
        &\mathrel{/} &\mathit{pat\_block}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{literal}^\mathrm{lit} \\
        &\mathrel{/} &\mathit{pat\_tuple}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{bindvar}^\mathrm{apt}
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{pat\_block}^\mathrm{apt}
        &\Coloneq &\mathrm{\#block\_items}(\mathit{view\_block\_item}^\mathrm{apt}{*}; \mathit{pat}^\mathrm{apt})
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{pat\_tuple}^\mathrm{apt}
        &\Coloneq &\mathrm{\#tuple}(\mathit{pat\_tuple\_item}^\mathrm{apt}{*}) \\
        \mathit{pat\_tuple\_item}^\mathrm{apt}
        &\Coloneq &\mathrm{\#bind}(\mathit{declvar}^\mathrm{apt}; \mathit{pat}^\mathrm{apt}) \\
        &\mathrel{/} &\mathit{pat}^\mathrm{apt}
    \end{array}
\end{align*}

View:

\begin{align*}
    \begin{array}{rcll}
        \mathit{view}^\mathrm{apt}
        &\Coloneq &\mathit{view\_block}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{view\_bind}^\mathrm{apt} \\
        &\mathrel{/} &\mathit{expr}^\mathrm{apt} \\
        \mathit{view\_bind}^\mathrm{apt}
        &\Coloneq &\mathrm{\#bind}(\mathit{pat}^\mathrm{apt}; \mathit{expr}^\mathrm{apt})
    \end{array}
\end{align*}

\begin{align*}
    \begin{array}{rcll}
        \mathit{view\_block}^\mathrm{apt}
        &\Coloneq &\mathrm{\#block\_items}(\mathit{view\_block\_item}^\mathrm{apt}{*}) \\
        \mathit{view\_block\_item}^\mathrm{apt}
        &\Coloneq &\mathrm{\#let}(\mathit{view\_let\_item}^\mathrm{apt}{*}) \\
        &\mathrel{/} &\mathit{view}^\mathrm{apt} \\
        \mathit{view\_let\_item}^\mathrm{apt}
        &\Coloneq &\mathit{view\_bind}^\mathrm{apt}
    \end{array}
\end{align*}

Basic Unit:

\begin{align*}
    \begin{array}{rcll}
        \mathit{declvar}^\mathrm{apt}
        &\Coloneq &\mathrm{\#var}(\mathit{var}^\mathrm{id}) \\
        \mathit{bindvar}^\mathrm{apt}
        &\Coloneq &\mathit{declvar}^\mathrm{apt} \\
        &\mathrel{/} &\mathrm{\#noname} \\
        \mathit{con}^\mathrm{apt}
        &\Coloneq &\mathrm{\#con}(\mathit{con}^\mathrm{id}) \\
        \mathit{var}^\mathrm{apt}
        &\Coloneq &\mathit{declvar}^\mathrm{apt}
    \end{array}
\end{align*}
